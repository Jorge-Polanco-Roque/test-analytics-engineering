# ============================================================================
# SQL LINTING WORKFLOW - ValidaciÃ³n de Sintaxis SQL
# ============================================================================
# Este workflow valida la sintaxis bÃ¡sica de archivos SQL usando sql-lint
# Es mÃ¡s simple que SQLFluff y no requiere configuraciÃ³n de DBT
# ============================================================================

name: SQL Lint

on:
  pull_request:
    paths:
      - 'dbt_project/models/**/*.sql'
      - 'dbt_project/macros/**/*.sql'
      - 'dbt_project/tests/**/*.sql'
  push:
    branches:
      - main
    paths:
      - 'dbt_project/models/**/*.sql'
      - 'dbt_project/macros/**/*.sql'
      - 'dbt_project/tests/**/*.sql'

jobs:
  sql-lint:
    name: ğŸ” Validar Sintaxis SQL
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------------------
      # 1. Checkout del cÃ³digo
      # -----------------------------------------------------------------------
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # 2. Setup Node.js (sql-lint es un paquete npm)
      # -----------------------------------------------------------------------
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # -----------------------------------------------------------------------
      # 3. Instalar sql-lint
      # -----------------------------------------------------------------------
      - name: ğŸ“¦ Install sql-lint
        run: npm install -g sql-lint

      # -----------------------------------------------------------------------
      # 4. Lint archivos SQL
      # -----------------------------------------------------------------------
      - name: ğŸ” Lint SQL files
        run: |
          echo "ğŸ” Validando sintaxis SQL..."

          # Encontrar todos los archivos .sql
          SQL_FILES=$(find dbt_project/models dbt_project/macros dbt_project/tests -name "*.sql" 2>/dev/null || true)

          if [ -z "$SQL_FILES" ]; then
            echo "âš ï¸  No se encontraron archivos SQL"
            exit 0
          fi

          # Contador de errores
          ERROR_COUNT=0

          # Validar cada archivo
          for file in $SQL_FILES; do
            echo "Checking: $file"

            # sql-lint ignora sintaxis de Jinja ({{ }}, {% %}), asÃ­ que usamos --ignore-errors
            # Solo queremos validar errores crÃ­ticos de sintaxis SQL
            if ! sql-lint "$file" --driver=postgres 2>&1 | grep -v "Unexpected token" | grep -v "{{" | grep -v "{%" > /dev/null; then
              echo "âœ… $file - OK"
            else
              echo "âŒ $file - ERRORES"
              sql-lint "$file" --driver=postgres || true
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ $ERROR_COUNT -eq 0 ]; then
            echo "âœ… Todos los archivos SQL tienen sintaxis vÃ¡lida"
            exit 0
          else
            echo "âŒ Se encontraron errores en $ERROR_COUNT archivo(s)"
            echo "âš ï¸  Nota: sql-lint puede reportar falsos positivos con sintaxis de Jinja"
            echo "    Revisa manualmente los errores reportados"
            exit 0  # No fallar el build por esto
          fi

      # -----------------------------------------------------------------------
      # 5. Comentar en PR si hay warnings
      # -----------------------------------------------------------------------
      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âš ï¸ **SQL Lint**: Se detectaron posibles problemas de sintaxis SQL. Revisa los logs del workflow para mÃ¡s detalles.'
            })
